<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin: Team Management | Echo Frontier</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    // Gatekeeper: Redirect to login if no token exists
    if (!localStorage.getItem('frontier_token')) {
        window.location.href = 'login.html';
    }
  </script>
</head>
<body>

<header>
  <div class="header-title">
    <img src="icon.png" alt="Studio Icon">
    <h1>Echo Frontier <span style="color: #6aa6ff; font-size: 0.8rem;">(Admin)</span></h1>
  </div>
</header>

<nav>
  <a href="private.html">Home</a>
  <a href="privateprojects.html">Projects</a>
  <a href="privatemembers.html" class="active">Members</a>
  <a href="privateprogress.html">Progress</a>
  <a href="privateavailability.html">Availability</a>
  <a href="index.html" onclick="logout()" style="color: #f7a6a6;">Logout</a>
</nav>

<main>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <h2>Team Management</h2>
    <button class="edit-btn" onclick="openAddModal()">+ Add Member</button>
  </div>
  
  <div class="members-grid" id="members-grid">
    </div>
</main>

<div id="edit-modal" class="modal-overlay">
  <div class="modal-card">
    <h3 id="modal-title">Edit Member</h3>
    <form id="edit-form">
      <input type="hidden" id="edit-index">
      <label>Name</label>
      <input type="text" id="edit-name" required>
      <label>Title</label>
      <input type="text" id="edit-title" required>
      <label>Avatar Path</label>
      <input type="text" id="edit-avatar" placeholder="images/team/photo.png">
      
      <div class="modal-actions">
        <button type="button" onclick="closeModal()" class="cancel-btn">Cancel</button>
        <button type="submit" class="save-btn">Save Changes</button>
      </div>
    </form>
  </div>
</div>

<footer>
    <p>&copy; 2026 Echo Frontier Studio. Internal Access Only.</p>
</footer>

<script>
  const jsonPath = './data/team.json';
  const socket = io("https://website-backend-k7zl.onrender.com");
  let currentTeam = [];

  // --- Core Functions ---

  function renderMembers() {
    const container = document.getElementById('members-grid');
    container.innerHTML = '';

    currentTeam.forEach((member, index) => {
      const card = document.createElement('div');
      card.className = 'member-card';
      const avatarSrc = member.avatar || 'https://via.placeholder.com/150';

      card.innerHTML = `
        <img src="${avatarSrc}" alt="${member.name}">
        <div class="member-name">${member.name}</div>
        <div class="member-title">${member.title}</div>
        <button class="edit-btn" onclick="openEditModal(${index})">
          <i class="fa-solid fa-pen-to-square"></i> Edit
        </button>
      `;
      container.appendChild(card);
    });
  }

  // Initial Load
  fetch(jsonPath)
    .then(res => res.json())
    .then(team => {
      currentTeam = team;
      renderMembers();
    })
    .catch(err => console.error("Error loading team:", err));

  // --- Modal Logic ---

  function openEditModal(index) {
    const member = currentTeam[index];
    document.getElementById('modal-title').innerText = "Edit Member";
    document.getElementById('edit-index').value = index;
    document.getElementById('edit-name').value = member.name;
    document.getElementById('edit-title').value = member.title;
    document.getElementById('edit-avatar').value = member.avatar || '';
    document.getElementById('edit-modal').style.display = 'flex';
  }

  function openAddModal() {
    document.getElementById('modal-title').innerText = "Add New Member";
    document.getElementById('edit-index').value = "new";
    document.getElementById('edit-form').reset();
    document.getElementById('edit-modal').style.display = 'flex';
  }

  function closeModal() {
    document.getElementById('edit-modal').style.display = 'none';
  }

  // --- Form Submission ---

  document.getElementById('edit-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const index = document.getElementById('edit-index').value;
    
    const memberData = {
      name: document.getElementById('edit-name').value,
      title: document.getElementById('edit-title').value,
      avatar: document.getElementById('edit-avatar').value
    };

    if (index === "new") {
      currentTeam.push(memberData);
    } else {
      currentTeam[parseInt(index)] = memberData;
    }

    // Save to server
    socket.emit('update-team-file', currentTeam);
    
    renderMembers();
    closeModal();
  });

  // --- Auth & Events ---

  function logout() {
      localStorage.removeItem('frontier_token');
      window.location.href = 'login.html';
  }

  socket.on('save-success', (msg) => {
      console.log(msg);
      // Optional: Show a "Saved" toast notification
  });

  socket.on('save-error', (err) => {
      alert("Error saving: " + err);
  });
</script>

</body>
</html>