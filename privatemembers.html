<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin: Team Management | Echo Frontier</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    if (!localStorage.getItem('frontier_token')) {
        window.location.href = 'login.html';
    }
  </script>
</head>
<body>

<header>
  <div class="header-title">
    <img src="icon.png" alt="Studio Icon">
    <h1>Echo Frontier <span style="color: #6aa6ff; font-size: 0.8rem;">(Admin)</span></h1>
  </div>
</header>

<nav>
  <a href="private.html">Home</a>
  <a href="privateprojects.html">Projects</a>
  <a href="privatemembers.html" class="active">Members</a>
  <a href="privateprogress.html">Progress</a>
  <a href="privateavailability.html">Availability</a>
  <a href="index.html" onclick="logout()" style="color: #f7a6a6;">Logout</a>
</nav>

<main>
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 0 10px;">
    <h2>Team Management</h2>
    <button class="edit-btn" onclick="openAddModal()">+ Add Member</button>
  </div>
  
  <div class="members-grid" id="members-grid">
      </div>
</main>

<div id="edit-modal" class="modal-overlay">
  <div class="modal-card" style="max-width: 450px;">
    <h3 id="modal-title">Edit Member</h3>
    <form id="edit-form">
      <input type="hidden" id="edit-index">
      
      <label>Name</label>
      <input type="text" id="edit-name" required placeholder="Member Name">
      
      <label>Title</label>
      <input type="text" id="edit-title" required placeholder="e.g. Lead Developer">
      
      <label>Member Photo (Local Upload)</label>
      <input type="file" id="member-file-input" accept="image/*" onchange="processFile(this)" style="margin-bottom: 10px;">
      
      <input type="hidden" id="edit-avatar-base64">

      <div id="avatar-preview-container" style="text-align: center; margin: 15px 0;">
          <img id="avatar-preview" src="https://via.placeholder.com/150" 
               style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid #6aa6ff; display: none;">
      </div>
      
      <div class="modal-actions">
        <button type="button" onclick="closeModal()" class="cancel-btn">Cancel</button>
        <button type="submit" class="save-btn">Save Member</button>
      </div>
    </form>
  </div>
</div>

<footer>
    <p>&copy; 2026 Echo Frontier Studio. Powered by Socket.io Engine.</p>
</footer>

<script>
  const socket = io("https://website-backend-k7zl.onrender.com");
  let currentTeam = [];

  // 1. Initial Load from MongoDB
  socket.on('connect', () => {
    console.log("Connected to MongoDB Member Sync");
    socket.emit('get-members');
  });

  socket.on('load-members', (team) => {
    currentTeam = team;
    renderMembers();
  });

  // 2. Render UI
  function renderMembers() {
    const container = document.getElementById('members-grid');
    container.innerHTML = '';

    currentTeam.forEach((member, index) => {
      const card = document.createElement('div');
      card.className = 'member-card';
      const avatarSrc = member.avatar || 'https://via.placeholder.com/150';

      card.innerHTML = `
        <img src="${avatarSrc}" alt="${member.name}" style="width:120px; height:120px; border-radius:50%; object-fit:cover;">
        <div class="member-name" style="margin-top:10px; font-weight:bold;">${member.name}</div>
        <div class="member-title" style="color:#6aa6ff; font-size:0.8rem; margin-bottom:15px;">${member.title}</div>
        <div style="display:flex; gap:10px; justify-content:center;">
            <button class="edit-btn" onclick="openEditModal(${index})"><i class="fa-solid fa-pen"></i></button>
            <button class="cancel-btn" onclick="deleteMember(${index})" style="padding:5px 10px; color:#f7a6a6; border:none; background:transparent; cursor:pointer;"><i class="fa-solid fa-trash"></i></button>
        </div>
      `;
      container.appendChild(card);
    });
  }

  // 3. File Processing (Local Drive to Base64)
  function processFile(input) {
    const file = input.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const base64 = e.target.result;
        document.getElementById('edit-avatar-base64').value = base64;
        const preview = document.getElementById('avatar-preview');
        preview.src = base64;
        preview.style.display = 'inline-block';
      };
      reader.readAsDataURL(file);
    }
  }

  // 4. Modal Controls
  function openEditModal(index) {
    const m = currentTeam[index];
    document.getElementById('modal-title').innerText = "Edit Member";
    document.getElementById('edit-index').value = index;
    document.getElementById('edit-name').value = m.name;
    document.getElementById('edit-title').value = m.title;
    document.getElementById('edit-avatar-base64').value = m.avatar || '';
    
    const preview = document.getElementById('avatar-preview');
    if (m.avatar) {
        preview.src = m.avatar;
        preview.style.display = 'inline-block';
    } else {
        preview.style.display = 'none';
    }
    
    document.getElementById('edit-modal').style.display = 'flex';
  }

  function openAddModal() {
    document.getElementById('modal-title').innerText = "Add New Member";
    document.getElementById('edit-index').value = "new";
    document.getElementById('edit-form').reset();
    document.getElementById('avatar-preview').style.display = 'none';
    document.getElementById('edit-avatar-base64').value = '';
    document.getElementById('edit-modal').style.display = 'flex';
  }

  function closeModal() {
    document.getElementById('edit-modal').style.display = 'none';
  }

  // 5. Submit to Server
  document.getElementById('edit-form').addEventListener('submit', (e) => {
    e.preventDefault();
    const index = document.getElementById('edit-index').value;
    
    const memberData = {
      name: document.getElementById('edit-name').value,
      title: document.getElementById('edit-title').value,
      avatar: document.getElementById('edit-avatar-base64').value
    };

    if (index === "new") {
      currentTeam.push(memberData);
    } else {
      currentTeam[parseInt(index)] = memberData;
    }

    socket.emit('update-team-file', currentTeam);
    closeModal();
  });

  function deleteMember(index) {
      if(confirm("Permanently remove this team member?")) {
          currentTeam.splice(index, 1);
          socket.emit('update-team-file', currentTeam);
      }
  }

  function logout() {
      localStorage.removeItem('frontier_token');
      window.location.href = 'login.html';
  }

  socket.on('save-success', () => console.log("Team updated successfully."));
</script>

</body>
</html>
